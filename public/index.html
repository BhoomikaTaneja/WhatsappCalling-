<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Calling Demo</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>WhatsApp Business Calling API Demo</h1>

    <div id="connectionStatus" class="connection-status disconnected">Disconnected</div>

    <!-- Step 1: Enable Calling -->
    <div class="card">
      <h2><span class="step">1</span> Enable Calling</h2>
      <p style="font-size: 13px; color: #6c757d; margin-bottom: 10px;">
        Enable voice calling on your WhatsApp Business phone number (one-time setup).
      </p>
      <div style="display: flex; gap: 10px;">
        <button id="btnEnableCalling" class="btn-primary" onclick="enableCalling()">Enable Calling</button>
        <button id="btnDisableCalling" class="btn-secondary" onclick="disableCalling()">Disable Calling</button>
      </div>
      <div id="enableStatus"></div>
    </div>

    <!-- Step 2: Send Permission Request -->
    <div class="card">
      <h2><span class="step">2</span> Request Call Permission</h2>
      <p style="font-size: 13px; color: #6c757d; margin-bottom: 10px;">
        Send a permission request to the user. They must accept before you can call them.
        Must have an active conversation open.
      </p>
      <div class="input-row">
        <input type="text" id="permissionPhone" placeholder="Phone number (e.g. 919876543210)">
        <input type="text" id="templateName" placeholder="Template name (default: call_permission)" style="max-width: 250px;">
        <button class="btn-primary" onclick="sendPermission()">Send Request</button>
      </div>
      <div id="permissionStatus"></div>
      <p class="permission-info">
        Limits: 1 request per 24 hours, 2 per week. Permission valid for 72 hours after accepted.
      </p>
    </div>

    <!-- Step 2.5: Check Permission (Optional) -->
    <div class="card">
      <h2><span class="step">&#10003;</span> Check Permission Status</h2>
      <div class="input-row">
        <input type="text" id="checkPermPhone" placeholder="Phone number to check">
        <button class="btn-secondary" onclick="checkPermission()">Check</button>
        <button class="btn-secondary" onclick="manualGrantPermission()">Grant Manually (Testing)</button>
      </div>
      <div id="checkPermStatus"></div>
    </div>

    <!-- Step 3: Initiate Call -->
    <div class="card">
      <h2><span class="step">3</span> Make Outbound Call</h2>
      <p style="font-size: 13px; color: #6c757d; margin-bottom: 10px;">
        Call a user who has granted permission. Your browser microphone will be used for the call.
      </p>
      <div class="input-row">
        <input type="text" id="callPhone" placeholder="Phone number to call">
        <button id="btnCall" class="btn-success" onclick="initiateCall()">Call</button>
      </div>
      <div id="callStatus"></div>
      <div class="call-controls" id="callControls" style="display: none;">
        <button class="btn-danger" onclick="endCall()">End Call</button>
        <span id="callDuration" style="font-size: 14px; color: #6c757d;"></span>
      </div>
    </div>

    <!-- Inbound Calls -->
    <div class="card" id="inboundCard" style="display: none;">
      <h2>Incoming Call</h2>
      <div id="inboundInfo"></div>
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn-success" id="btnAcceptCall" onclick="acceptInboundCall()">Accept</button>
        <button class="btn-danger" onclick="rejectInboundCall()">Reject</button>
      </div>
    </div>

    <!-- Send Message (Helper) -->
    <div class="card">
      <h2>Send Message (to open conversation)</h2>
      <div class="input-row">
        <input type="text" id="msgPhone" placeholder="Phone number">
        <input type="text" id="msgText" placeholder="Message text" style="flex: 2;">
        <button class="btn-primary" onclick="sendMessage()">Send</button>
      </div>
      <div id="msgStatus"></div>
    </div>

    <!-- Event Log -->
    <div class="card">
      <h2>Event Log</h2>
      <button class="btn-secondary" onclick="clearLog()" style="margin-bottom: 8px; padding: 4px 12px; font-size: 12px;">Clear</button>
      <div id="eventLog"></div>
    </div>
  </div>

  <audio id="remoteAudio" autoplay></audio>

  <script src="/socket.io/socket.io.js"></script>
  <script src="app.js"></script>
</body>
</html>
